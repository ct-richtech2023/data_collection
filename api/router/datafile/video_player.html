<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCAPè§†é¢‘æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .annotation-title {
            margin-top: 8px;
            font-size: 1.05em;
            font-weight: 600;
            color: #856404;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            display: block;          /* å•ç‹¬æˆè¡Œ */
            width: 100%;             /* å æ»¡ä¸€è¡Œ */
            text-align: center;      /* å±…ä¸­æ˜¾ç¤º */
            padding: 6px 12px;
            border-radius: 6px;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: bold;
            color: #495057;
            min-width: 120px;
        }

        input[type="text"], input[type="number"] {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            flex: 1;
            min-width: 200px;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .video-container {
            padding: 30px;
            text-align: center;
        }

        .video-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .camera-view {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .camera-view:hover {
            transform: translateY(-5px);
        }

        .camera-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            line-height: 1.3;
            word-break: break-all;
            font-family: 'Courier New', monospace;
        }
        
        .camera-title .status-info {
            font-size: 0.8em;
            font-weight: normal;
            color: #6c757d;
            margin-left: 8px;
            white-space: nowrap;
        }

        .camera-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            object-fit: contain;
            background: #f8f9fa;
            transition: opacity 0.2s ease-in-out;
            display: block;
        }
        
        .camera-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .camera-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .camera-item:hover {
            background: #e9ecef;
        }
        
        .camera-item.selected {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .camera-image.loading {
            opacity: 0.7;
        }
        
        .camera-view {
            transition: all 0.1s ease-in-out;
        }
        
        .camera-title {
            transition: color 0.1s ease-in-out;
        }

        .playback-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .playback-info {
            background: #e9ecef;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            color: #495057;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .playback-controls {
                flex-direction: column;
            }
            
            .video-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ MCAPå®æ—¶æµæ’­æ”¾å™¨</h1>
            <p>å®æ—¶æµå¼ä¼ è¾“MCAPæ–‡ä»¶ä¸­çš„ç›¸æœºè§†é¢‘æ•°æ®</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="filePath">MCAPæ–‡ä»¶è·¯å¾„:</label>
                <input type="text" id="filePath" value="20250817_144725.mcap" placeholder="è¾“å…¥MCAPæ–‡ä»¶è·¯å¾„">
            </div>
            
            <div class="control-group">
                <label for="maxFrames">æœ€å¤§å¸§æ•°:</label>
                <input type="number" id="maxFrames" value="100" min="1" max="1000">
            </div>
            
            
            <div class="control-group">
                <label for="topicSelect">é€‰æ‹©ç›¸æœº (æ”¯æŒå¤šé€‰):</label>
                <div id="cameraSelection" style="flex: 1; min-width: 300px; max-width: 600px;">
                    <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">è¯·å…ˆåŠ è½½MCAPæ–‡ä»¶è·å–ç›¸æœºåˆ—è¡¨</p>
                </div>
            </div>
            
            <div class="control-group">
                <button onclick="loadMCAP()">ğŸ“ åŠ è½½MCAPæ–‡ä»¶</button>
                <button onclick="loadTopics()">ğŸ“‹ è·å–ç›¸æœºåˆ—è¡¨</button>
                <button onclick="startRealtimeStream()" id="streamBtn">ğŸš€ å®æ—¶æµå¼ä¼ è¾“</button>
                <button onclick="stopRealtimeStream()" id="stopStreamBtn" disabled>â¹ï¸ åœæ­¢æµå¼ä¼ è¾“</button>
                <button onclick="toggleAutoPlay()" id="playBtn" style="background: #28a745;">â–¶ï¸ è‡ªåŠ¨æ’­æ”¾</button>
                <button onclick="clearFrames()" id="clearBtn" style="background: #dc3545;">ğŸ—‘ï¸ é‡Šæ”¾å†…å­˜</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="video-container">
            <div class="playback-controls">
                <div class="playback-info" id="playbackInfo">
                    æ—¶é—´: 0.00s | ç›¸æœº: 0ä¸ª
                </div>
                <div id="annotationTitle" class="annotation-title" style="display:none;"></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="video-display" id="videoDisplay">
                <p style="text-align: center; color: #6c757d; font-size: 1.2em;">
                    è¯·å…ˆåŠ è½½MCAPæ–‡ä»¶å’Œè§†é¢‘å¸§
                </p>
            </div>
        </div>
    </div>

    <script>
        // ========== æœåŠ¡å™¨é…ç½® ==========
        // è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ä»¥ä¸‹é…ç½®
        const SERVER_CONFIG = {
            host: '192.168.2.131',        // æœåŠ¡å™¨IPåœ°å€ï¼Œå¯ä»¥æ˜¯ 'localhost', '127.0.0.1' æˆ–å®é™…IPåœ°å€
            httpPort: 9000,           // HTTP APIç«¯å£ï¼ˆWebSocketä¹Ÿåœ¨åŒä¸€ç«¯å£ï¼‰
            // æ³¨æ„ï¼šFastAPI çš„ WebSocket å’Œ HTTP API åœ¨åŒä¸€ä¸ªç«¯å£ä¸Šè¿è¡Œ
            // ä¸éœ€è¦å•ç‹¬çš„ wsPortï¼Œå¦‚æœè®¾ç½®äº†ä¸åŒçš„ç«¯å£ä¼šå¯¼è‡´è¿æ¥å¤±è´¥
        };
        
        // æ„å»ºAPIåŸºç¡€URL
        const API_BASE_URL = `http://${SERVER_CONFIG.host}:${SERVER_CONFIG.httpPort}`;
        // æ„å»ºWebSocket URLï¼ˆFastAPI WebSocket å’Œ HTTP API åœ¨åŒä¸€ä¸ªç«¯å£ï¼‰
        const WS_PORT = SERVER_CONFIG.httpPort;  // WebSocket ä½¿ç”¨ HTTP ç«¯å£
        const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_BASE_URL = `${WS_PROTOCOL}//${SERVER_CONFIG.host}:${WS_PORT}`;
        
        let currentFrames = [];
        let currentFrameIndex = 0;
        let fps = 30; // é»˜è®¤30fps
        let selectedTopics = []; // é€‰ä¸­çš„å¤šä¸ªtopics
        let availableTopics = []; // å¯ç”¨çš„topicsåˆ—è¡¨
        // æ³¨é‡Šï¼š[{timestamp_ns, text, frame_index}]
        let annotations = [];
        let annotationTimestamps = []; // å‡åºçº³ç§’æ•°ç»„
        let annotationTexts = []; // å¯¹åº”æ–‡æœ¬
        
        // WebSocketè¿æ¥
        let websocket = null;
        let isStreaming = false;
        let streamedFrames = {}; // å­˜å‚¨æ¯ä¸ªç›¸æœºçš„æµå¼æ¥æ”¶å¸§ {topic: [frames]}
        let cameraViews = {}; // å­˜å‚¨æ¯ä¸ªç›¸æœºçš„è§†å›¾å…ƒç´ 
        let lastFrameTime = 0; // æœ€åä¸€å¸§æ¥æ”¶æ—¶é—´
        let frameTimeout = null; // å¸§è¶…æ—¶æ£€æµ‹
        let displayThrottle = null; // æ˜¾ç¤ºèŠ‚æµ
        let lastDisplayTime = 0; // æœ€åæ˜¾ç¤ºæ—¶é—´
        let statusThrottle = null; // çŠ¶æ€æ›´æ–°èŠ‚æµ
        let lastStatusTime = 0; // æœ€åçŠ¶æ€æ›´æ–°æ—¶é—´
        let performanceMode = 'normal'; // æ€§èƒ½æ¨¡å¼ï¼šnormal, high, low
        let frameDropCount = 0; // ä¸¢å¸§è®¡æ•°
        let isAutoPlaying = false; // è‡ªåŠ¨æ’­æ”¾çŠ¶æ€
        let playInterval = null; // æ’­æ”¾å®šæ—¶å™¨

        // èŠ‚æµçŠ¶æ€æ›´æ–°å‡½æ•°
        function throttledShowStatus(message, type = 'info') {
            const now = Date.now();
            const minInterval = 200; // æœ€å°200msé—´éš”ï¼Œæé«˜å“åº”æ€§
            
            if (now - lastStatusTime < minInterval) {
                if (statusThrottle) {
                    clearTimeout(statusThrottle);
                }
                statusThrottle = setTimeout(() => {
                    showStatus(message, type);
                    lastStatusTime = Date.now();
                }, minInterval - (now - lastStatusTime));
                return;
            }
            
            showStatus(message, type);
            lastStatusTime = now;
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            // åªåœ¨éæµå¼ä¼ è¾“æ—¶è‡ªåŠ¨éšè—
            if (!isStreaming) {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // åŠ è½½MCAPæ–‡ä»¶
        async function loadMCAP() {
            const filePath = document.getElementById('filePath').value;
            if (!filePath) {
                showStatus('è¯·è¾“å…¥MCAPæ–‡ä»¶è·¯å¾„', 'error');
                return;
            }

            showLoading(true);
            try {
                // ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„å’Œå‚æ•°å
                const response = await fetch(`${API_BASE_URL}/datafile/load_mcap?file_path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    showStatus('MCAPæ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                    fps = data.file_info.video_fps || 30;
                    // è¯»å–æ³¨é‡Š
                    if (Array.isArray(data.annotations)) {
                        setupAnnotations(data.annotations);
                    } else {
                        try {
                            const annRes = await fetch(`${API_BASE_URL}/datafile/get_annotations`);
                            const annData = await annRes.json();
                            if (annData.success && Array.isArray(annData.annotations)) {
                                setupAnnotations(annData.annotations);
                            }
                        } catch (e) {}
                    }
                } else {
                    showStatus('MCAPæ–‡ä»¶åŠ è½½å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('åŠ è½½MCAPæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function setupAnnotations(list) {
            annotations = (list || []).filter(a => a && typeof a.timestamp_ns === 'number');
            annotations.sort((a,b) => a.timestamp_ns - b.timestamp_ns);
            annotationTimestamps = annotations.map(a => a.timestamp_ns);
            annotationTexts = annotations.map(a => a.text || '');
            const at = document.getElementById('annotationTitle');
            if (annotations.length > 0 && at) {
                at.style.display = 'inline-block';
                at.textContent = '';
            }
        }

        function updateAnnotationTitleByNs(currentNs) {
            const at = document.getElementById('annotationTitle');
            if (!at || annotationTimestamps.length === 0) return;
            // äºŒåˆ†æŸ¥æ‰¾ï¼šæ‰¾åˆ° <= currentNs çš„æœ€å¤§ä¸‹æ ‡
            let lo = 0, hi = annotationTimestamps.length - 1, ans = -1;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                if (annotationTimestamps[mid] <= currentNs) {
                    ans = mid; lo = mid + 1;
                } else hi = mid - 1;
            }
            if (ans >= 0) {
                at.textContent = annotationTexts[ans] || '';
                at.style.display = (annotationTexts[ans] && annotationTexts[ans].length) ? 'inline-block' : 'none';
            } else {
                at.textContent = '';
                at.style.display = 'none';
            }
        }

        // è·å–æ‰€æœ‰topic
        async function loadTopics() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/datafile/get_all_topics`);
                const data = await response.json();
                
                if (data.success) {
                    const cameraSelection = document.getElementById('cameraSelection');
                    cameraSelection.innerHTML = '';
                    
                    availableTopics = data.topics;
                    
                    data.topics.forEach(topic => {
                        const cameraItem = document.createElement('div');
                        cameraItem.className = 'camera-item';
                        cameraItem.innerHTML = `
                            <input type="checkbox" class="camera-checkbox" id="camera_${topic}" value="${topic}" onchange="toggleCamera('${topic}')">
                            <label for="camera_${topic}" style="flex: 1; cursor: pointer;">${topic}</label>
                        `;
                        cameraSelection.appendChild(cameraItem);
                    });
                    
                    showStatus(`æ‰¾åˆ° ${data.topics.length} ä¸ªç›¸æœºï¼Œè¯·é€‰æ‹©è¦æµå¼ä¼ è¾“çš„ç›¸æœº`, 'success');
                } else {
                    showStatus('è·å–ç›¸æœºåˆ—è¡¨å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('è·å–ç›¸æœºåˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // åˆå§‹åŒ–å¤šæ‘„åƒå¤´æ˜¾ç¤º
        function initializeMultiCameraDisplay() {
            const videoDisplay = document.getElementById('videoDisplay');
            videoDisplay.innerHTML = '';
            cameraViews = {};
            
            selectedTopics.forEach(topic => {
                const cameraView = document.createElement('div');
                cameraView.className = 'camera-view';
                cameraView.id = `camera_${topic}`;
                cameraView.innerHTML = `
                    <div class="camera-title">${topic}</div>
                    <img class="camera-image" alt="${topic}">
                    <div class="error-message" style="display:none; text-align:center; color:#dc3545; padding:20px;">
                        å›¾åƒåŠ è½½å¤±è´¥
                    </div>
                `;
                videoDisplay.appendChild(cameraView);
                cameraViews[topic] = cameraView;
            });
        }
        
        // åˆ‡æ¢ç›¸æœºé€‰æ‹©
        function toggleCamera(topic) {
            const checkbox = document.getElementById(`camera_${topic}`);
            const cameraItem = checkbox.closest('.camera-item');
            
            if (checkbox.checked) {
                if (!selectedTopics.includes(topic)) {
                    selectedTopics.push(topic);
                }
                cameraItem.classList.add('selected');
            } else {
                selectedTopics = selectedTopics.filter(t => t !== topic);
                cameraItem.classList.remove('selected');
            }
            
            console.log(`å½“å‰é€‰ä¸­çš„ç›¸æœº: ${selectedTopics.join(', ')}`);
            showStatus(`å·²é€‰æ‹© ${selectedTopics.length} ä¸ªç›¸æœº: ${selectedTopics.join(', ')}`, 'info');
        }

        
        // å®æ—¶æµå¼ä¼ è¾“è§†é¢‘
        async function startRealtimeStream() {
            const maxFrames = document.getElementById('maxFrames').value;
            
            if (selectedTopics.length === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªç›¸æœº', 'error');
                return;
            }
            
            if (isStreaming) {
                showStatus('å·²ç»åœ¨æµå¼ä¼ è¾“ä¸­', 'warning');
                return;
            }
            
            try {
                // åˆå§‹åŒ–å¤šæ‘„åƒå¤´æ˜¾ç¤º
                initializeMultiCameraDisplay();
                
                // å»ºç«‹WebSocketè¿æ¥ï¼ˆFastAPI WebSocket å’Œ HTTP API åœ¨åŒä¸€ä¸ªç«¯å£ï¼‰
                const wsUrl = `${WS_PROTOCOL}//${SERVER_CONFIG.host}:${SERVER_CONFIG.httpPort}/datafile/ws/stream`;
                console.log(`æ­£åœ¨è¿æ¥WebSocket: ${wsUrl}`);
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    showStatus(`WebSocketè¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹æµå¼ä¼ è¾“ ${selectedTopics.length} ä¸ªç›¸æœº...`, 'info');
                    
                    // ä¸ºæ¯ä¸ªé€‰ä¸­çš„ç›¸æœºå‘é€æµå¼ä¼ è¾“å‘½ä»¤
                    selectedTopics.forEach(topic => {
                        const message = {
                            action: "start_stream",
                            topic: topic,
                            fps: fps,
                            max_frames: parseInt(maxFrames)
                        };
                        console.log(`å‘é€ç›¸æœº ${topic} çš„WebSocketæ¶ˆæ¯:`, message);
                        websocket.send(JSON.stringify(message));
                    });
                    
                    isStreaming = true;
                    streamedFrames = {};
                    selectedTopics.forEach(topic => {
                        streamedFrames[topic] = [];
                    });
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('streamBtn').disabled = true;
                    document.getElementById('stopStreamBtn').disabled = false;
                };
                
                websocket.onmessage = function(event) {
                    console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', event.data);
                    const data = JSON.parse(event.data);
                    console.log('è§£æåçš„æ•°æ®:', data);
                    
                    if (data.type === 'frame') {
                        const topic = data.topic;
                        console.log(`æ¥æ”¶åˆ°ç›¸æœº ${topic} çš„å¸§æ•°æ® - å¸§ç´¢å¼•: ${data.frame_index}, å½¢çŠ¶: ${data.shape}`);
                        
                        // æ›´æ–°æœ€åå¸§æ¥æ”¶æ—¶é—´
                        lastFrameTime = Date.now();
                        
                        // æ¸…é™¤è¶…æ—¶æ£€æµ‹
                        if (frameTimeout) {
                            clearTimeout(frameTimeout);
                        }
                        
                        // æ¥æ”¶åˆ°çš„å¸§æ•°æ®å­˜å‚¨åˆ°å¯¹åº”ç›¸æœº
                        if (!streamedFrames[topic]) {
                            streamedFrames[topic] = [];
                        }
                        streamedFrames[topic].push(data);
                        
                        // å®æ—¶æ˜¾ç¤ºè¯¥ç›¸æœºçš„å¸§
                        displayCameraFrame(topic, data);
                        
                        // æ›´æ–°æ’­æ”¾ä¿¡æ¯
                        updatePlaybackInfo();
                        
                        // æ€§èƒ½è‡ªé€‚åº”è°ƒæ•´
                        adjustPerformanceMode();
                        
                        // åªåœ¨å¼€å§‹æ—¶æ˜¾ç¤ºä¸€æ¬¡çŠ¶æ€æ¶ˆæ¯
                        const totalFrames = Object.values(streamedFrames).reduce((sum, frames) => sum + frames.length, 0);
                        if (totalFrames === 1) {
                            showStatus('å¼€å§‹å®æ—¶æ¥æ”¶å¸§æ•°æ®...', 'info');
                        }
                        
                        // æ³¨é‡Šæ‰å¸§æ•°é™åˆ¶ï¼Œå…è®¸è·å–å…¨éƒ¨å¸§æ•°
                        // const maxFrames = performanceMode === 'low' ? 80 : (performanceMode === 'high' ? 150 : 300);
                        // if (streamedFrames.length > maxFrames) {
                        //     streamedFrames.shift(); // ç§»é™¤æœ€æ—§çš„å¸§
                        //     currentFrames = streamedFrames;
                        // }
                        
                        // è®¾ç½®å¸§è¶…æ—¶æ£€æµ‹ï¼ˆ5ç§’æ— æ–°å¸§åˆ™è­¦å‘Šï¼‰
                        frameTimeout = setTimeout(() => {
                            if (isStreaming) {
                                showStatus('è­¦å‘Šï¼šè¶…è¿‡5ç§’æœªæ¥æ”¶åˆ°æ–°å¸§', 'warning');
                            }
                        }, 5000);
                        
                    } else if (data.type === 'complete') {
                        console.log('æµå¼ä¼ è¾“å®Œæˆ:', data.message);
                        showStatus(data.message, 'success');
                        isStreaming = false;
                        
                        // éšè—çŠ¶æ€æ¶ˆæ¯
                        setTimeout(() => {
                            const status = document.getElementById('status');
                            status.style.display = 'none';
                        }, 2000);
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        document.getElementById('streamBtn').disabled = false;
                        document.getElementById('stopStreamBtn').disabled = true;
                        
                    } else if (data.type === 'error') {
                        console.error('æµå¼ä¼ è¾“é”™è¯¯:', data.message);
                        showStatus('æµå¼ä¼ è¾“é”™è¯¯: ' + data.message, 'error');
                        isStreaming = false;
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        document.getElementById('streamBtn').disabled = false;
                        document.getElementById('stopStreamBtn').disabled = true;
                    } else {
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
                    }
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocketè¿æ¥å·²å…³é—­', event);
                    isStreaming = false;
                    showStatus(`WebSocketè¿æ¥å·²å…³é—­ (ä»£ç : ${event.code})`, 'warning');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('streamBtn').disabled = false;
                    document.getElementById('stopStreamBtn').disabled = true;
                    document.getElementById('playBtn').disabled = false;
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                    showStatus('WebSocketè¿æ¥é”™è¯¯', 'error');
                    isStreaming = false;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('streamBtn').disabled = false;
                    document.getElementById('stopStreamBtn').disabled = true;
                    document.getElementById('playBtn').disabled = false;
                };
                
            } catch (error) {
                showStatus('å¯åŠ¨æµå¼ä¼ è¾“å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºå•ä¸ªç›¸æœºçš„å¸§
        function displayCameraFrame(topic, frame) {
            const cameraView = cameraViews[topic];
            if (!cameraView) return;
            
            const titleElement = cameraView.querySelector('.camera-title');
            const imgElement = cameraView.querySelector('.camera-image');
            
            if (titleElement) {
                const frameCount = streamedFrames[topic] ? streamedFrames[topic].length : 0;
                titleElement.innerHTML = `${topic}<span class="status-info">(${frameCount}å¸§)</span>`;
            }
            
            if (imgElement && frame.image_data) {
                imgElement.src = frame.image_data;
                
                imgElement.onload = function() {
                    this.style.opacity = '1';
                    this.classList.remove('loading');
                };
                
                imgElement.onerror = function() {
                    this.style.display = 'none';
                    const errorDiv = cameraView.querySelector('.error-message');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                    }
                };
            }
        }
        
        // é‡Šæ”¾å†…å­˜ - æ¸…ç©ºæ‰€æœ‰å¸§æ•°æ®
        function clearFrames() {
            const totalFrameCount = Object.values(streamedFrames).reduce((sum, frames) => sum + frames.length, 0);
            
            // åœæ­¢è‡ªåŠ¨æ’­æ”¾
            stopAutoPlay();
            
            streamedFrames = {};
            cameraViews = {};
            selectedTopics = [];
            currentFrameIndex = 0;
            
            // æ¸…ç©ºæ˜¾ç¤º
            const videoDisplay = document.getElementById('videoDisplay');
            videoDisplay.innerHTML = '<p style="text-align: center; color: #6c757d; font-size: 1.2em;">è¯·å…ˆåŠ è½½MCAPæ–‡ä»¶å’Œè§†é¢‘å¸§</p>';
            
            // é‡ç½®è¿›åº¦æ¡
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '0%';
            
            // é‡ç½®æ’­æ”¾ä¿¡æ¯
            const playbackInfo = document.getElementById('playbackInfo');
            playbackInfo.textContent = 'æ—¶é—´: 0.00s | ç›¸æœº: 0ä¸ª | æ€»å¸§: 0';
            
            // æ¸…é™¤æ‰€æœ‰å¤é€‰æ¡†é€‰æ‹©
            document.querySelectorAll('.camera-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.camera-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
            if (window.gc) {
                window.gc();
            }
            
            showStatus(`å·²é‡Šæ”¾å†…å­˜ï¼Œæ¸…ç©ºäº† ${totalFrameCount} å¸§æ•°æ®`, 'success');
            console.log(`å†…å­˜å·²é‡Šæ”¾ï¼Œæ¸…ç©ºäº† ${totalFrameCount} å¸§æ•°æ®`);
        }

        // åœæ­¢å®æ—¶æµå¼ä¼ è¾“
        function stopRealtimeStream() {
            if (websocket && isStreaming) {
                websocket.send(JSON.stringify({
                    action: "stop_stream"
                }));
                websocket.close();
                isStreaming = false;
                showStatus('å·²åœæ­¢æµå¼ä¼ è¾“', 'info');
                
                // æ¸…é™¤è¶…æ—¶æ£€æµ‹
                if (frameTimeout) {
                    clearTimeout(frameTimeout);
                    frameTimeout = null;
                }
                
                // æ¸…é™¤æ˜¾ç¤ºèŠ‚æµ
                if (displayThrottle) {
                    clearTimeout(displayThrottle);
                    displayThrottle = null;
                }
                
                // æ¸…é™¤çŠ¶æ€èŠ‚æµ
                if (statusThrottle) {
                    clearTimeout(statusThrottle);
                    statusThrottle = null;
                }
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('streamBtn').disabled = false;
                document.getElementById('stopStreamBtn').disabled = true;
            }
        }

        // æ€§èƒ½è‡ªé€‚åº”è°ƒæ•´ - ç§»é™¤å¸§æ•°é™åˆ¶ï¼Œå…è®¸è·å–å…¨éƒ¨å¸§æ•°
        function adjustPerformanceMode() {
            const totalFrameCount = Object.values(streamedFrames).reduce((sum, frames) => sum + frames.length, 0);
            
            // åªè°ƒæ•´æ€§èƒ½æ¨¡å¼ï¼Œä¸é™åˆ¶å¸§æ•°
            if (totalFrameCount > 1000) {
                performanceMode = 'low';
                console.log(`æ€§èƒ½æ¨¡å¼åˆ‡æ¢åˆ°ä½æ€§èƒ½æ¨¡å¼ï¼Œå½“å‰æ€»å¸§æ•°: ${totalFrameCount}`);
            } else if (totalFrameCount > 500) {
                performanceMode = 'high';
                console.log(`æ€§èƒ½æ¨¡å¼åˆ‡æ¢åˆ°é«˜æ€§èƒ½æ¨¡å¼ï¼Œå½“å‰æ€»å¸§æ•°: ${totalFrameCount}`);
            } else {
                performanceMode = 'normal';
            }
            
            // æ˜¾ç¤ºå½“å‰å¸§æ•°çŠ¶æ€å’Œå†…å­˜è­¦å‘Š
            if (totalFrameCount % 100 === 0 && totalFrameCount > 0) {
                console.log(`å½“å‰å·²æ¥æ”¶æ€»å¸§æ•°: ${totalFrameCount}ï¼Œæ€§èƒ½æ¨¡å¼: ${performanceMode}`);
                
                // æ˜¾ç¤ºæ¯ä¸ªç›¸æœºçš„å¸§æ•°
                Object.keys(streamedFrames).forEach(topic => {
                    const frameCount = streamedFrames[topic].length;
                    console.log(`  - ${topic}: ${frameCount} å¸§`);
                });
                
                // å†…å­˜è­¦å‘Šï¼ˆä½†ä¸é™åˆ¶å¸§æ•°ï¼‰
                if (totalFrameCount > 2000) {
                    console.warn(`âš ï¸ å·²æ¥æ”¶ ${totalFrameCount} å¸§ï¼Œå†…å­˜ä½¿ç”¨è¾ƒé«˜ï¼Œå»ºè®®åœ¨å®Œæˆåé‡Šæ”¾`);
                }
            }
        }

        // èŠ‚æµæ˜¾ç¤ºå‡½æ•° - ä¼˜åŒ–æ’­æ”¾é€Ÿåº¦
        function throttledDisplayCurrentFrame() {
            const now = Date.now();
            
            // æ ¹æ®FPSè®¡ç®—å¸§é—´éš”ï¼Œå®ç°æ­£å¸¸æ’­æ”¾é€Ÿåº¦
            const frameInterval = 1000 / fps; // æ¯«ç§’é—´éš”
            
            if (now - lastDisplayTime < frameInterval) {
                frameDropCount++;
                if (displayThrottle) {
                    clearTimeout(displayThrottle);
                }
                displayThrottle = setTimeout(() => {
                    displayCurrentFrame();
                    lastDisplayTime = Date.now();
                }, frameInterval - (now - lastDisplayTime));
                return;
            }
            
            displayCurrentFrame();
            lastDisplayTime = now;
            frameDropCount = 0;
        }

        // æ›´æ–°æ’­æ”¾ä¿¡æ¯æ˜¾ç¤º
        function updatePlaybackInfo() {
            const playbackInfo = document.getElementById('playbackInfo');
            const now = Date.now();
            
            if (!playbackInfo.lastUpdate || now - playbackInfo.lastUpdate > 100) {
                // è®¡ç®—æ€»å¸§æ•°å’Œæœ€æ–°æ—¶é—´
                const totalFrames = Object.values(streamedFrames).reduce((sum, frames) => sum + frames.length, 0);
                const activeCameras = Object.keys(streamedFrames).filter(topic => 
                    streamedFrames[topic] && streamedFrames[topic].length > 0
                ).length;
                
                // è·å–æœ€æ–°çš„æ—¶é—´æˆ³
                let latestTime = 0;
                Object.values(streamedFrames).forEach(frames => {
                    if (frames.length > 0) {
                        const lastFrame = frames[frames.length - 1];
                        if (lastFrame.timestamp > latestTime) {
                            latestTime = lastFrame.timestamp;
                        }
                    }
                });
                
                const timeInSeconds = latestTime > 0 ? (latestTime / 1e9).toFixed(2) : '0.00';
                const playStatus = isAutoPlaying ? ' | è‡ªåŠ¨æ’­æ”¾ä¸­' : ' | æš‚åœ';
                playbackInfo.textContent = `æ—¶é—´: ${timeInSeconds}s | ç›¸æœº: ${activeCameras}ä¸ª | æ€»å¸§: ${totalFrames}${playStatus}`;
                playbackInfo.lastUpdate = now;

                // æ›´æ–°é¡¶éƒ¨æ³¨é‡Šæ ‡é¢˜
                if (latestTime > 0) {
                    updateAnnotationTitleByNs(latestTime);
                }
            }
        }

        // å¼€å§‹è‡ªåŠ¨æ’­æ”¾
        function startAutoPlay() {
            if (isAutoPlaying) return;
            
            const totalFrames = Object.values(streamedFrames).reduce((sum, frames) => sum + frames.length, 0);
            if (totalFrames === 0) {
                showStatus('æ²¡æœ‰å¯æ’­æ”¾çš„å¸§æ•°æ®', 'error');
                return;
            }
            
            isAutoPlaying = true;
            const frameInterval = 1000 / fps; // æ ¹æ®FPSè®¡ç®—é—´éš”
            
            playInterval = setInterval(() => {
                // æ‰¾åˆ°æ‰€æœ‰ç›¸æœºä¸­æœ€å°çš„å¸§æ•°ï¼Œç¡®ä¿åŒæ­¥æ’­æ”¾
                const minFrames = Math.min(...Object.values(streamedFrames).map(frames => frames.length));
                if (minFrames === 0) return;
                
                // ä¸ºæ¯ä¸ªç›¸æœºæ˜¾ç¤ºå¯¹åº”ç´¢å¼•çš„å¸§
                Object.keys(streamedFrames).forEach(topic => {
                    const frames = streamedFrames[topic];
                    if (frames.length > 0 && currentFrameIndex < frames.length) {
                        displayCameraFrame(topic, frames[currentFrameIndex]);
                    }
                });
                
                // æ›´æ–°å½“å‰å¸§ç´¢å¼•
                currentFrameIndex = (currentFrameIndex + 1) % minFrames;
                
                // æ›´æ–°æ’­æ”¾ä¿¡æ¯
                updatePlaybackInfo();
                
            }, frameInterval);
            
            showStatus(`å¼€å§‹è‡ªåŠ¨æ’­æ”¾ï¼ŒFPS: ${fps}`, 'success');
        }

        // åœæ­¢è‡ªåŠ¨æ’­æ”¾
        function stopAutoPlay() {
            if (!isAutoPlaying) return;
            
            isAutoPlaying = false;
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            
            showStatus('åœæ­¢è‡ªåŠ¨æ’­æ”¾', 'info');
        }

        // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
        function toggleAutoPlay() {
            if (isAutoPlaying) {
                stopAutoPlay();
            } else {
                startAutoPlay();
            }
        }


        // é”®ç›˜æ§åˆ¶ - æ’­æ”¾æ§åˆ¶å’Œå¸§å¯¼èˆª
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                toggleAutoPlay();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                stopAutoPlay(); // åœæ­¢è‡ªåŠ¨æ’­æ”¾
                if (Object.values(streamedFrames).some(frames => frames.length > 0)) {
                    currentFrameIndex = Math.max(0, currentFrameIndex - 1);
                    // æ˜¾ç¤ºæ‰€æœ‰ç›¸æœºçš„å½“å‰å¸§
                    Object.keys(streamedFrames).forEach(topic => {
                        const frames = streamedFrames[topic];
                        if (frames.length > 0 && currentFrameIndex < frames.length) {
                            displayCameraFrame(topic, frames[currentFrameIndex]);
                        }
                    });
                    updatePlaybackInfo();
                }
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                stopAutoPlay(); // åœæ­¢è‡ªåŠ¨æ’­æ”¾
                if (Object.values(streamedFrames).some(frames => frames.length > 0)) {
                    const maxFrames = Math.min(...Object.values(streamedFrames).map(frames => frames.length));
                    currentFrameIndex = Math.min(maxFrames - 1, currentFrameIndex + 1);
                    // æ˜¾ç¤ºæ‰€æœ‰ç›¸æœºçš„å½“å‰å¸§
                    Object.keys(streamedFrames).forEach(topic => {
                        const frames = streamedFrames[topic];
                        if (frames.length > 0 && currentFrameIndex < frames.length) {
                            displayCameraFrame(topic, frames[currentFrameIndex]);
                        }
                    });
                    updatePlaybackInfo();
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('æ¬¢è¿ä½¿ç”¨MCAPå®æ—¶æµæ’­æ”¾å™¨ï¼è¯·å…ˆåŠ è½½MCAPæ–‡ä»¶', 'info');
        });
    </script>
</body>
</html>
